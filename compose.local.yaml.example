name: local-wiki # DO NOT CHANGE THIS, THIS WILL BREAK JUSTSCRIPTS AND OTHER AUTOMATIONS

services:
  mediawiki:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        MEDIAWIKI_MAJOR_VERSION: ${MEDIAWIKI_MAJOR_VERSION}
        MEDIAWIKI_VERSION: ${MEDIAWIKI_VERSION}
        MEDIAWIKI_BRANCH: ${MEDIAWIKI_BRANCH}
        CITIZEN_VERSION: ${CITIZEN_VERSION}
    container_name: local-wiki-mediawiki
    depends_on:
      valkey:
        condition: service_started
      mariadb:
        condition: service_healthy
    volumes:
      - wiki-webroot:/var/www/wiki
      - .env:/var/www/wiki/.env:ro
    networks:
      - wiki-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "php-fpm", "-t" ]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    user: "1000:1000"
    expose:
      - '9000'

  nginx:
    image: nginx:stable-alpine
    container_name: local-wiki-nginx
    depends_on:
      mediawiki:
        condition: service_healthy
    environment:
      NGINX_SERVER_NAME: ${SITENAME}
      NGINX_ENVSUBST_OUTPUT_DIR: /etc/nginx/conf.d
    volumes:
      - wiki-webroot:/var/www/wiki:ro
      - ./wiki/mediawiki.conf:/etc/nginx/templates/mediawiki.conf.template:ro
      - ./wiki/default.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - '3000:80'
    networks:
      - wiki-network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

  valkey:
    image: valkey/valkey:alpine
    container_name: local-wiki-valkey
    volumes:
      - valkey-data:/data
    networks:
      - wiki-network
    command: valkey-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "valkey-cli", "ping" ]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    expose:
      - '6379'

  mariadb:
    image: mariadb:latest
    container_name: local-wiki-mariadb
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_NAME}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    volumes:
      - ./database:/var/lib/mysql
    networks:
      - wiki-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3
    expose:
      - '3306'

  minio:
    image: minio/minio:latest
    container_name: local-wiki-minio
    environment:
      MINIO_ROOT_USER: ${MINIO_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_PASSWORD}
    volumes:
      - ./images:/data
    networks:
      - wiki-network
    command: server /data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    expose:
      - '9000'

  opensearch:
    image: opensearchproject/opensearch:1.3.20
    container_name: local-wiki-opensearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - cluster.name=mediwiki-cluster
      - node.name=mediwiki-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - plugins.security.disabled=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - ./opensearch:/usr/share/opensearch/data
    networks:
      - wiki-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    expose:
      - '9200'

networks:
  wiki-network:
    driver: bridge

volumes:
  wiki-webroot:
    driver: local
  valkey-data:
    driver: local
